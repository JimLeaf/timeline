<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Site Timeline</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans&display=swap" rel="stylesheet">
  <style>
    body {
      background: #f5f5f5;
      margin: 0;
      padding: 60px 0;
      font-family: 'Noto Sans', sans-serif;
    }

    .timeline-wrapper {
      position: relative;
      width: 100%;
      overflow: hidden;
      display: flex;
      justify-content: center;
    }

    .timeline {
      position: relative;
      display: inline-block;
      transform-origin: top center;
      transition: transform 0.3s ease;
    }

    .timeline-line {
      position: absolute;
      left: 50%;
      width: 4px;
      background-color: #007bff;
      transform: translateX(-50%);
      z-index: 0;
      pointer-events: none;
    }

    .timeline-row {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      position: relative;
      margin: 80px 0;
      width: 100%;
    }

    .date-range {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      z-index: 2;
      width: 150px;
      text-align: center;
      background-color: #fff;
      border: 2px solid #007bff;
      border-radius: 10px;
      padding: 10px;
      font-size: 16px;
      color: #007bff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .left-events,
    .right-events {
      display: flex;
      gap: 5px;
      flex-wrap: nowrap;
      flex-shrink: 0;
      width: 50%;
      box-sizing: border-box;
    }

    .left-events {
      justify-content: flex-end;
      padding-right: 90px;
      margin-right: 10px;
    }

    .right-events {
      justify-content: flex-start;
      padding-left: 90px;
      margin-left: 10px;
    }

    .event-box-left,
    .event-box-right {
      position: relative;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      font-size: 14px;
      color: #333;
      width: 280px;
      flex-shrink: 0;
      overflow: visible;
    }

    .event-box-left { text-align: right; }
    .event-box-right { text-align: left; }

    .event-fill {
      height: 20px;
      width: 100%;
      margin-bottom: 10px;
      border-top-left-radius: 8px;
      border-top-right-radius: 8px;
      display: flex;
      overflow: hidden;
    }

    .event-fill.solid { display: block; }
    .fill-half { width: 50%; height: 100%; }

    .event-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 12px 16px;
      text-align: center;
    }

    .event-content .event-img {
      width: 260px;
      height: auto;
      display: block;
      margin: -10px 0;
      align-self: center;
      object-fit: cover;
      border-radius: 4px;
    }

    .event-title {
      font-weight: bold;
      font-size: 14px;
      text-align: center;
      margin-top: 10px;
      margin-bottom: 0px;
    }

    .event-description {
      text-align: left;
      font-size: 13px;
      margin-bottom: 20px;
    }

    .icon-row {
      position: absolute;
      top: -10px;
      display: flex;
      gap: 5px;
    }

    .icon-row.left { left: 5px; justify-content: flex-start; }
    .icon-row.right { right: 5px; justify-content: flex-end; }

    .icon-img {
      width: 30px;
      height: 30px;
      margin: -5px -2px;
      vertical-align: middle;
      object-fit: contain;
    }

    .button-grid {
      position: absolute;
      bottom: -50px;
      display: grid;
      grid-template-columns: repeat(2, 50px);
      grid-template-rows: repeat(2, 20px);
      gap: 3px;
      margin-bottom: 20px;
    }

    .button-grid.left { left: 0; }
    .button-grid.right { right: 0; }

    .button-box {
      width: 50px;
      height: 20px;
      background-color: #fff;
      border: 1px solid #dddddd;
      border-radius: 3px;
      color: #000;
      font-size: 12px;
      font-family: 'Noto Sans', sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .connector {
      position: absolute;
      height: 4px;
      background-color: #007bff;
      z-index: 1;
    }

    .connector.segment { background-color: #007bff; }

    .timeline-search {
      text-align: center;
      margin-bottom: 0px;
      margin-top: 0;
    }

    #timeline { margin-top: -50px; }

    #timeline-search-input {
      width: 60%;
      max-width: 400px;
      padding: 8px 12px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    .highlight { background-color: yellow; font-weight: bold; }

    #back-to-top {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: 2px solid #333;
      background-color: #fff;
      color: #333;
      font-size: 32px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.5s ease;
    }

    #back-to-top.show {
      opacity: 1;
      pointer-events: auto;
    }

    #back-to-top:hover { background-color: #f0f0f0; }

    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      align-items: center;
      gap: 3px;
      padding: 3px 0;
    }

    .icon-item, .rectangle-item {
      display: flex;
      align-items: center;
      gap: 3px;
      font-size: 14px;
    }

    .icon-item img { width: 20px; height: 20px; display: block; }

    .color-rectangle {
      width: 25px;
      height: 15px;
      border-radius: 6px;
      border: none;
      display: block;
    }

    .rect-blue   { background-color: #007bff; }
    .rect-red    { background-color: #f34848; }
    .rect-orange { background-color: #f39c12; }
    .rect-purple { background-color: #9b59b6; }
    .rect-green  { background-color: #2ecc71; }

    .timeline-card {
    position: fixed;       
    top: 80px;              
    left: 50%;
    transform: translateX(-50%);
    z-index: 100;           
    width: 175px;
    border-radius: 10px;
    background: #ffffff;
    box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    overflow: hidden;
    transition: top 0.4s ease;
}


    .header-bar {
      background-color: #007BFF;
      color: #ffffff;
      padding: 8px 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }

    .header-label { font-size: 14px; font-weight: bold; }
    .header-icon  { font-size: 14px; }

    .legend-content { padding: 10px; font-size: 13px; }
    .timeline-card.collapsed .legend-content { display: none; }

    /* Fill colors */
    .fill-red { background-color: #e74c3c; }
    .fill-blue { background-color: #3498db; }
    .fill-green { background-color: #2ecc71; }
    .fill-orange { background-color: #f39c12; }
    .fill-purple { background-color: #9b59b6; }
  </style>
</head>
<body>

  <!-- Search Bar -->
  <div class="timeline-search">
    <input type="text" id="timeline-search-input" placeholder="Search timeline..." />
  </div>

  <!-- Timeline Wrapper -->
  <div class="timeline-wrapper">
    <!-- Timeline -->
    <div id="timeline" class="timeline">
      <div class="timeline-line" id="timeline-line"></div>
    </div>

    <!-- Legend Card -->
    <div class="timeline-card" id="legend">
      <div class="header-bar" id="legend-toggle">
        <span class="header-label">LEGEND</span>
        <span class="header-icon">▼</span>
      </div>

      <div class="legend-content">
        <div class="row">
          <div class="icon-item">
            <img src="https://raw.githubusercontent.com/jimleaf/timeline/main/icons/runaway.png" alt="Runaway Icon">
            <span>RA</span>
          </div>
          <div class="rectangle-item">
            <div class="color-rectangle rect-orange"></div>
            <span>Meta</span>
          </div>
        </div>

        <div class="row">
          <div class="icon-item">
            <img src="https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png" alt="Front Icon">
            <span>Front</span>
          </div>
          <div class="rectangle-item">
            <div class="color-rectangle rect-purple"></div>
            <span>Luxury</span>
          </div>
        </div>

        <div class="row">
          <div class="icon-item">
            <img src="https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png" alt="Pace Icon">
            <span>Pace</span>
          </div>
          <div class="rectangle-item">
            <div class="color-rectangle rect-green"></div>
            <span>Niche</span>
          </div>
        </div>

        <div class="row">
          <div class="icon-item">
            <img src="https://raw.githubusercontent.com/jimleaf/timeline/main/icons/late.png" alt="Late Icon">
            <span>Late</span>
          </div>
          <div class="rectangle-item">
            <div class="color-rectangle rect-red"></div>
            <span>Oshi</span>
          </div>
        </div>

        <div class="row">
          <div class="icon-item">
            <img src="https://raw.githubusercontent.com/jimleaf/timeline/main/icons/end.png" alt="End Icon">
            <span>End</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Back to Top Button -->
  <button id="back-to-top" title="Back to Top">↑</button>

  <script>
    // =======================
    // Step 1: Event data
    // =======================
    const events = [
      { side: "left", range: "JAN 01 – JAN 23", title: "Tamamo Cross", description: `One of the strongest banners going into Unity and Make a New Track (MANT). 15 Race Bonus and 2 Wits bonus might put this card below Fine Motion, but for Unity shorts and mile CMs you will run multiple wits cards anyway. Great Stats and a highly desirable gold skill on any late surger for more gambling.`, fills: ["fill-green"], image: "https://raw.githubusercontent.com/jimleaf/timeline/main/images/0120-left-1.png", iconsLeft: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png", "https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], iconsRight: [], buttonsLeft: ["DIRT","MILE","MED","LONG"], buttonsRight: [] },
      { side: "right", range: "JAN 01 – JAN 23", title: "Nice Nature Wit & Oguri Cap Power", description: `One of the strongest banners going into Unity and Make a New Track (MANT). 15 Race Bonus and 2 Wits bonus might put this card below Fine Motion, but for Unity shorts and mile CMs you will run multiple wits cards anyway. Great Stats and a highly desirable gold skill on any late surger for more gambling.`, fills: ["fill-purple","fill-green"], image: "https://raw.githubusercontent.com/jimleaf/timeline/main/images/0120-right-1.png", iconsLeft: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], iconsRight: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], buttonsLeft: ["DIRT","MILE","MED","LONG"], buttonsRight: ["DIRT","MILE","MED","LONG"] },
      { side: "left", range: "JAN 27 - FEB 07", title: "NY Haru Urara & NY T.M. Opera", description: `One of the strongest banners going into Unity and Make a New Track (MANT). 15 Race Bonus and 2 Wits bonus might put this card below Fine Motion, but for Unity shorts and mile CMs you will run multiple wits cards anyway. Great Stats and a highly desirable gold skill on any late surger for more gambling.`, fills: ["fill-purple","fill-orange"], image: "https://raw.githubusercontent.com/jimleaf/timeline/main/images/0127-left-1.png", iconsLeft: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], iconsRight: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], buttonsLeft: ["DIRT","MILE","MED","LONG"], buttonsRight: ["DIRT","MILE","MED","LONG"] },
      { side: "right", range: "JAN 27 - FEB 07", title: "Admire Vega Power & Fukukitaru Speed", description: `One of the strongest banners going into Unity and Make a New Track (MANT). 15 Race Bonus and 2 Wits bonus might put this card below Fine Motion, but for Unity shorts and mile CMs you will run multiple wits cards anyway. Great Stats and a highly desirable gold skill on any late surger for more gambling.`, fills: ["fill-purple","fill-orange"], image: "https://raw.githubusercontent.com/jimleaf/timeline/main/images/0127-right-1.png", iconsLeft: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], iconsRight: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], buttonsLeft: ["DIRT","MILE","MED","LONG"], buttonsRight: ["DIRT","MILE","MED","LONG"] },
      { side: "right", range: "JAN 27 - FEB 07", title: "Meishi Doto Stamina Card", description: `One of the strongest banners going into Unity and Make a New Track (MANT). 15 Race Bonus and 2 Wits bonus might put this card below Fine Motion, but for Unity shorts and mile CMs you will run multiple wits cards anyway. Great Stats and a highly desirable gold skill on any late surger for more gambling.`, fills: ["fill-green"], image: "https://raw.githubusercontent.com/jimleaf/timeline/main/images/0127-right-2.png", iconsLeft: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], iconsRight: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], buttonsLeft: ["DIRT","MILE","MED","LONG"], buttonsRight: ["DIRT","MILE","MED","LONG"] },
      { side: "left", range: "FEB 03 - FEB 12", title: "Character Banner", description: `One of the strongest banners going into Unity and Make a New Track (MANT). 15 Race Bonus and 2 Wits bonus might put this card below Fine Motion, but for Unity shorts and mile CMs you will run multiple wits cards anyway. Great Stats and a highly desirable gold skill on any late surger for more gambling.`, fills: ["fill-purple"], image: "https://raw.githubusercontent.com/jimleaf/timeline/main/images/0203-left-1.png", iconsLeft: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], iconsRight: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], buttonsLeft: ["DIRT","MILE","MED","LONG"], buttonsRight: ["DIRT","MILE","MED","LONG"] },
      { side: "right", range: "FEB 03 - FEB 12", title: "S. Anshinzawa Friend & Tamamo Cross Guts", description: `One of the strongest banners going into Unity and Make a New Track (MANT). 15 Race Bonus and 2 Wits bonus might put this card below Fine Motion, but for Unity shorts and mile CMs you will run multiple wits cards anyway. Great Stats and a highly desirable gold skill on any late surger for more gambling.`, fills: ["fill-green"], image: "https://raw.githubusercontent.com/jimleaf/timeline/main/images/0203-right-1.png", iconsLeft: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], iconsRight: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], buttonsLeft: ["DIRT","MILE","MED","LONG"], buttonsRight: ["DIRT","MILE","MED","LONG"] },
      { side: "left", range: "FEB 07 - MAR 27", title: "New Year Paid Banner (Uma)", description: `One of the strongest banners going into Unity and Make a New Track (MANT). 15 Race Bonus and 2 Wits bonus might put this card below Fine Motion, but for Unity shorts and mile CMs you will run multiple wits cards anyway. Great Stats and a highly desirable gold skill on any late surger for more gambling.`, fills: ["fill-purple"], image: "https://raw.githubusercontent.com/jimleaf/timeline/main/images/0207-left-1.png", iconsLeft: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], iconsRight: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], buttonsLeft: ["DIRT","MILE","MED","LONG"], buttonsRight: ["DIRT","MILE","MED","LONG"] },
      { side: "right", range: "FEB 07 - MAR 27", title: "New Year Paid Banner (Support Card)", description: `One of the strongest banners going into Unity and Make a New Track (MANT). 15 Race Bonus and 2 Wits bonus might put this card below Fine Motion, but for Unity shorts and mile CMs you will run multiple wits cards anyway. Great Stats and a highly desirable gold skill on any late surger for more gambling.`, fills: ["fill-purple"], image: "https://raw.githubusercontent.com/jimleaf/timeline/main/images/0207-right-1.png", iconsLeft: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], iconsRight: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], buttonsLeft: ["DIRT","MILE","MED","LONG"], buttonsRight: ["DIRT","MILE","MED","LONG"] },
      { side: "left", range: "FEB 09 - FEB 17", title: "Sakura Chiyono O", description: `One of the strongest banners going into Unity and Make a New Track (MANT). 15 Race Bonus and 2 Wits bonus might put this card below Fine Motion, but for Unity shorts and mile CMs you will run multiple wits cards anyway. Great Stats and a highly desirable gold skill on any late surger for more gambling.`, fills: ["fill-green"], image: "https://raw.githubusercontent.com/jimleaf/timeline/main/images/0209-left-1.png", iconsLeft: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], iconsRight: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], buttonsLeft: ["DIRT","MILE","MED","LONG"], buttonsRight: ["DIRT","MILE","MED","LONG"] },
      { side: "left", range: "FEB 15 - FEB 27", title: "Val. Mihono Bourbon & Val. Eishin Flash", description: `One of the strongest banners going into Unity and Make a New Track (MANT). 15 Race Bonus and 2 Wits bonus might put this card below Fine Motion, but for Unity shorts and mile CMs you will run multiple wits cards anyway. Great Stats and a highly desirable gold skill on any late surger for more gambling.`, fills: ["fill-orange"], image: "https://raw.githubusercontent.com/jimleaf/timeline/main/images/0215-left-1.png", iconsLeft: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], iconsRight: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], buttonsLeft: ["DIRT","MILE","MED","LONG"], buttonsRight: ["DIRT","MILE","MED","LONG"] },
      { side: "right", range: "FEB 15 - FEB 27", title: "Nishino Flower Wit & Sakura Baksuhin O Guts", description: `One of the strongest banners going into Unity and Make a New Track (MANT). 15 Race Bonus and 2 Wits bonus might put this card below Fine Motion, but for Unity shorts and mile CMs you will run multiple wits cards anyway. Great Stats and a highly desirable gold skill on any late surger for more gambling.`, fills: ["fill-green"], image: "https://raw.githubusercontent.com/jimleaf/timeline/main/images/0215-right-1.png", iconsLeft: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], iconsRight: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], buttonsLeft: ["DIRT","MILE","MED","LONG"], buttonsRight: ["DIRT","MILE","MED","LONG"] },
      { side: "right", range: "FEB 15 - FEB 27", title: "Tosen Jordan SSR Speed", description: `One of the strongest banners going into Unity and Make a New Track (MANT). 15 Race Bonus and 2 Wits bonus might put this card below Fine Motion, but for Unity shorts and mile CMs you will run multiple wits cards anyway. Great Stats and a highly desirable gold skill on any late surger for more gambling.`, fills: ["fill-green"], image: "https://raw.githubusercontent.com/jimleaf/timeline/main/images/0215-right-2.png", iconsLeft: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], iconsRight: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], buttonsLeft: ["DIRT","MILE","MED","LONG"], buttonsRight: ["DIRT","MILE","MED","LONG"] },
      { side: "left", range: "FEB 23 - MAR 03", title: "Mejiro Ardan", description: `One of the strongest banners going into Unity and Make a New Track (MANT). 15 Race Bonus and 2 Wits bonus might put this card below Fine Motion, but for Unity shorts and mile CMs you will run multiple wits cards anyway. Great Stats and a highly desirable gold skill on any late surger for more gambling.`, fills: ["fill-green"], image: "https://raw.githubusercontent.com/jimleaf/timeline/main/images/0223-left-1.png", iconsLeft: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], iconsRight: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], buttonsLeft: ["DIRT","MILE","MED","LONG"], buttonsRight: ["DIRT","MILE","MED","LONG"] },
      { side: "right", range: "FEB 23 - MAR 03", title: "Agnes Digital  SSR Power & Ines Fujin SR Wit", description: `One of the strongest banners going into Unity and Make a New Track (MANT). 15 Race Bonus and 2 Wits bonus might put this card below Fine Motion, but for Unity shorts and mile CMs you will run multiple wits cards anyway. Great Stats and a highly desirable gold skill on any late surger for more gambling.`, fills: ["fill-green"], image: "https://raw.githubusercontent.com/jimleaf/timeline/main/images/0223-right-1.png", iconsLeft: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], iconsRight: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], buttonsLeft: ["DIRT","MILE","MED","LONG"], buttonsRight: ["DIRT","MILE","MED","LONG"] },
      { side: "left", range: "FEB 28 - MAR 08", title: "Admire Vega ♡", description: `One of the strongest banners going into Unity and Make a New Track (MANT). 15 Race Bonus and 2 Wits bonus might put this card below Fine Motion, but for Unity shorts and mile CMs you will run multiple wits cards anyway. Great Stats and a highly desirable gold skill on any late surger for more gambling.`, fills: ["fill-green"], image: "https://raw.githubusercontent.com/jimleaf/timeline/main/images/0228-left-1.png", iconsLeft: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], iconsRight: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], buttonsLeft: ["DIRT","MILE","MED","LONG"], buttonsRight: ["DIRT","MILE","MED","LONG"] },
      { side: "right", range: "FEB 28 - MAR 08", title: "Fine Motion Wit & Kawakami Princess Speed", description: `One of the strongest banners going into Unity and Make a New Track (MANT). 15 Race Bonus and 2 Wits bonus might put this card below Fine Motion, but for Unity shorts and mile CMs you will run multiple wits cards anyway. Great Stats and a highly desirable gold skill on any late surger for more gambling.`, fills: ["fill-orange","fill-green"], image: "https://raw.githubusercontent.com/jimleaf/timeline/main/images/0228-right-1.png", iconsLeft: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], iconsRight: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], buttonsLeft: ["DIRT","MILE","MED","LONG"], buttonsRight: ["DIRT","MILE","MED","LONG"] },
      { side: "left", range: "MAR 06 - MAR 17", title: "Kitasan Black & Matikanetannhauser", description: `One of the strongest banners going into Unity and Make a New Track (MANT). 15 Race Bonus and 2 Wits bonus might put this card below Fine Motion, but for Unity shorts and mile CMs you will run multiple wits cards anyway. Great Stats and a highly desirable gold skill on any late surger for more gambling.`, fills: ["fill-purple","fill-green"], image: "https://raw.githubusercontent.com/jimleaf/timeline/main/images/0306-left-1.png", iconsLeft: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], iconsRight: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], buttonsLeft: ["DIRT","MILE","MED","LONG"], buttonsRight: ["DIRT","MILE","MED","LONG"] },
      { side: "right", range: "MAR 06 - MAR 17", title: "Narita Top Road SSR Speed & Admire Vega SR Guts", description: `One of the strongest banners going into Unity and Make a New Track (MANT). 15 Race Bonus and 2 Wits bonus might put this card below Fine Motion, but for Unity shorts and mile CMs you will run multiple wits cards anyway. Great Stats and a highly desirable gold skill on any late surger for more gambling.`, fills: ["fill-purple","fill-orange"], image: "https://raw.githubusercontent.com/jimleaf/timeline/main/images/0306-right-1.png", iconsLeft: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], iconsRight: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], buttonsLeft: ["DIRT","MILE","MED","LONG"], buttonsRight: ["DIRT","MILE","MED","LONG"] },
      { side: "right", range: "MAR 06 - MAR 17", title: "Mejiro Bright SSR Stamina", description: `One of the strongest banners going into Unity and Make a New Track (MANT). 15 Race Bonus and 2 Wits bonus might put this card below Fine Motion, but for Unity shorts and mile CMs you will run multiple wits cards anyway. Great Stats and a highly desirable gold skill on any late surger for more gambling.`, fills: ["fill-green"], image: "https://raw.githubusercontent.com/jimleaf/timeline/main/images/0306-right-2.png", iconsLeft: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], iconsRight: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], buttonsLeft: ["DIRT","MILE","MED","LONG"], buttonsRight: ["DIRT","MILE","MED","LONG"] },
      { side: "left", range: "MAR 13 - MAR 24", title: "Satono Diamond", description: `One of the strongest banners going into Unity and Make a New Track (MANT). 15 Race Bonus and 2 Wits bonus might put this card below Fine Motion, but for Unity shorts and mile CMs you will run multiple wits cards anyway. Great Stats and a highly desirable gold skill on any late surger for more gambling.`, fills: ["fill-purple"], image: "https://raw.githubusercontent.com/jimleaf/timeline/main/images/0313-left-1.png", iconsLeft: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], iconsRight: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], buttonsLeft: ["DIRT","MILE","MED","LONG"], buttonsRight: ["DIRT","MILE","MED","LONG"] },
      { side: "right", range: "MAR 13 - MAR 24", title: "Marvelous Sunday SSR Guts & Curren SR Speed", description: `One of the strongest banners going into Unity and Make a New Track (MANT). 15 Race Bonus and 2 Wits bonus might put this card below Fine Motion, but for Unity shorts and mile CMs you will run multiple wits cards anyway. Great Stats and a highly desirable gold skill on any late surger for more gambling.`, fills: ["fill-green","fill-purple"], image: "https://raw.githubusercontent.com/jimleaf/timeline/main/images/0313-right-1.png", iconsLeft: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], iconsRight: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], buttonsLeft: ["DIRT","MILE","MED","LONG"], buttonsRight: ["DIRT","MILE","MED","LONG"] },
      { side: "left", range: "MAR 21 - APR 01", title: "Mejiro Bright", description: `One of the strongest banners going into Unity and Make a New Track (MANT). 15 Race Bonus and 2 Wits bonus might put this card below Fine Motion, but for Unity shorts and mile CMs you will run multiple wits cards anyway. Great Stats and a highly desirable gold skill on any late surger for more gambling.`, fills: ["fill-green"], image: "https://raw.githubusercontent.com/jimleaf/timeline/main/images/0321-left-1.png", iconsLeft: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], iconsRight: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], buttonsLeft: ["DIRT","MILE","MED","LONG"], buttonsRight: ["DIRT","MILE","MED","LONG"] },
      { side: "right", range: "MAR 21 - APR 01", title: "Zenno Rob Roy SSR Speed & Curren SSR Wit", description: `One of the strongest banners going into Unity and Make a New Track (MANT). 15 Race Bonus and 2 Wits bonus might put this card below Fine Motion, but for Unity shorts and mile CMs you will run multiple wits cards anyway. Great Stats and a highly desirable gold skill on any late surger for more gambling.`, fills: ["fill-purple"], image: "https://raw.githubusercontent.com/jimleaf/timeline/main/images/0321-right-1.png", iconsLeft: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], iconsRight: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], buttonsLeft: ["DIRT","MILE","MED","LONG"], buttonsRight: ["DIRT","MILE","MED","LONG"] },
      { side: "left", range: "MAR 21 - APR 12", title: "1st Anniversary Paid Banner (Uma)", description: `One of the strongest banners going into Unity and Make a New Track (MANT). 15 Race Bonus and 2 Wits bonus might put this card below Fine Motion, but for Unity shorts and mile CMs you will run multiple wits cards anyway. Great Stats and a highly desirable gold skill on any late surger for more gambling.`, fills: ["fill-purple"], image: "https://raw.githubusercontent.com/jimleaf/timeline/main/images/0322-left-1.png", iconsLeft: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], iconsRight: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], buttonsLeft: ["DIRT","MILE","MED","LONG"], buttonsRight: ["DIRT","MILE","MED","LONG"] },
      { side: "right", range: "MAR 21 - APR 12", title: "1st Anniversary Paid Banner (Support Card)", description: `One of the strongest banners going into Unity and Make a New Track (MANT). 15 Race Bonus and 2 Wits bonus might put this card below Fine Motion, but for Unity shorts and mile CMs you will run multiple wits cards anyway. Great Stats and a highly desirable gold skill on any late surger for more gambling.`, fills: ["fill-purple"], image: "https://raw.githubusercontent.com/jimleaf/timeline/main/images/0322-right-1.png", iconsLeft: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], iconsRight: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], buttonsLeft: ["DIRT","MILE","MED","LONG"], buttonsRight: ["DIRT","MILE","MED","LONG"] },
      { side: "left", range: "MAR 29 - APR 11", title: "Ballroom Seiun Sky & Ballroom Fuji Kiseki", description: `One of the strongest banners going into Unity and Make a New Track (MANT). 15 Race Bonus and 2 Wits bonus might put this card below Fine Motion, but for Unity shorts and mile CMs you will run multiple wits cards anyway. Great Stats and a highly desirable gold skill on any late surger for more gambling.`, fills: ["fill-orange","fill-purple"], image: "https://raw.githubusercontent.com/jimleaf/timeline/main/images/0329-left-1.png", iconsLeft: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], iconsRight: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], buttonsLeft: ["DIRT","MILE","MED","LONG"], buttonsRight: ["DIRT","MILE","MED","LONG"] },
      { side: "right", range: "MAR 29 - APR 11", title: "Symboli Rudolf SSR Stam & Sirius Symboli SSR Wit", description: `One of the strongest banners going into Unity and Make a New Track (MANT). 15 Race Bonus and 2 Wits bonus might put this card below Fine Motion, but for Unity shorts and mile CMs you will run multiple wits cards anyway. Great Stats and a highly desirable gold skill on any late surger for more gambling.`, fills: ["fill-green"], image: "https://raw.githubusercontent.com/jimleaf/timeline/main/images/0329-right-1.png", iconsLeft: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], iconsRight: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], buttonsLeft: ["DIRT","MILE","MED","LONG"], buttonsRight: ["DIRT","MILE","MED","LONG"] },
      { side: "right", range: "MAR 29 - APR 11", title: "Air Shakur SSR Speed Card", description: `One of the strongest banners going into Unity and Make a New Track (MANT). 15 Race Bonus and 2 Wits bonus might put this card below Fine Motion, but for Unity shorts and mile CMs you will run multiple wits cards anyway. Great Stats and a highly desirable gold skill on any late surger for more gambling.`, fills: ["fill-green"], image: "https://raw.githubusercontent.com/jimleaf/timeline/main/images/0329-right-2.png", iconsLeft: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], iconsRight: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], buttonsLeft: ["DIRT","MILE","MED","LONG"], buttonsRight: ["DIRT","MILE","MED","LONG"] },
      { side: "left", range: "APR 07 - APR 14", title: "Nishino Flower", description: `One of the strongest banners going into Unity and Make a New Track (MANT). 15 Race Bonus and 2 Wits bonus might put this card below Fine Motion, but for Unity shorts and mile CMs you will run multiple wits cards anyway. Great Stats and a highly desirable gold skill on any late surger for more gambling.`, fills: ["fill-orange"], image: "https://raw.githubusercontent.com/jimleaf/timeline/main/images/0407-left-1.png", iconsLeft: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], iconsRight: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], buttonsLeft: ["DIRT","MILE","MED","LONG"], buttonsRight: ["DIRT","MILE","MED","LONG"] },
      { side: "right", range: "APR 07 - APR 14", title: "Daiwa Scarlet SSR Power & Sweep Tosho Wit", description: `One of the strongest banners going into Unity and Make a New Track (MANT). 15 Race Bonus and 2 Wits bonus might put this card below Fine Motion, but for Unity shorts and mile CMs you will run multiple wits cards anyway. Great Stats and a highly desirable gold skill on any late surger for more gambling.`, fills: ["fill-green"], image: "https://raw.githubusercontent.com/jimleaf/timeline/main/images/0407-right-1.png", iconsLeft: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], iconsRight: ["https://raw.githubusercontent.com/jimleaf/timeline/main/icons/front.png","https://raw.githubusercontent.com/jimleaf/timeline/main/icons/pace.png"], buttonsLeft: ["DIRT","MILE","MED","LONG"], buttonsRight: ["DIRT","MILE","MED","LONG"] }
    ];

    // =======================
    // Step 2: Rendering helpers
    // =======================
    function renderIcons(iconList = [], align) {
      return `
        <div class="icon-row ${align || ""}">
          ${iconList
            .map(icon => {
              const isImage =
                typeof icon === "string" &&
                (icon.endsWith(".png") || icon.endsWith(".jpg") || icon.endsWith(".jpeg") || icon.endsWith(".svg") || icon.startsWith("http"));
              return isImage
                ? `<img src="${icon}" alt="icon" class="icon-img" />`
                : `<span class="icon-emoji">${icon}</span>`;
            })
            .join("")}
        </div>
      `;
    }

    function renderButtons(buttonList = [], align) {
      if (!buttonList.length) return "";
      return `
        <div class="button-grid ${align || ""}">
          ${buttonList.map(label => `<div class="button-box">${label}</div>`).join("")}
        </div>
      `;
    }

    function renderFill(fills = []) {
      if (!fills.length) return "";
      if (fills.length === 1) {
        return `<div class="event-fill solid ${fills[0]}"></div>`;
      }
      return `
        <div class="event-fill">
          <div class="fill-half ${fills[0]}"></div>
          <div class="fill-half ${fills[1]}"></div>
        </div>
      `;
    }

    // =======================
    // Step 3: Render timeline
    // =======================
    function renderTimeline(evts) {
      const timeline = document.getElementById("timeline");
      if (!timeline) return;

      timeline.innerHTML = '<div class="timeline-line" id="timeline-line"></div>';

      const grouped = {};
      evts.forEach(ev => {
        const key = ev.range || "Unscheduled";
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push(ev);
      });

      Object.keys(grouped).forEach(range => {
        const row = document.createElement("div");
        row.className = "timeline-row";

        const leftContainer = document.createElement("div");
        leftContainer.className = "left-events";

        const dateRange = document.createElement("div");
        dateRange.className = "date-range";
        dateRange.textContent = range;

        const connector = document.createElement("div");
        connector.className = "connector";

        const rightContainer = document.createElement("div");
        rightContainer.className = "right-events";

        grouped[range].forEach(ev => {
          const box = document.createElement("div");
          box.className = ev.side === "left" ? "event-box-left" : "event-box-right";
          box.innerHTML = `
            ${renderFill(ev.fills)}
            <div class="event-content">
              ${ev.image ? `<img src="${ev.image}" alt="${ev.title || "event image"}" class="event-img" />` : ""}
              <div class="event-title">${ev.title || ""}</div>
              <p class="event-description">${ev.description || ""}</p>
              ${renderIcons(ev.iconsLeft || [], "left")}
              ${renderIcons(ev.iconsRight || [], "right")}
            </div>
            ${renderButtons(ev.buttonsLeft || [], "left")}
            ${renderButtons(ev.buttonsRight || [], "right")}
          `;
          const target = ev.side === "left" ? leftContainer : rightContainer;
          target.appendChild(box);
        });

        row.appendChild(leftContainer);
        row.appendChild(dateRange);
        row.appendChild(connector);
        row.appendChild(rightContainer);
        timeline.appendChild(row);
      });

      const imgs = timeline.querySelectorAll("img");
      imgs.forEach(img => {
        img.addEventListener("load", () => {
          positionTimelineLine();
          positionConnectors();
        });
      });
    }

    // =======================
    // Step 4: Scaling + connectors
    // =======================
    function scaleTimeline() {
      const wrapper = document.querySelector(".timeline-wrapper");
      const timeline = document.querySelector(".timeline");
      if (!wrapper || !timeline) return;

      const wrapperWidth = wrapper.offsetWidth;
      const timelineWidth = timeline.scrollWidth;
      const scale = Math.min(1, wrapperWidth / (timelineWidth || 1));
      timeline.style.transformOrigin = "top left";
      timeline.style.transform = `scale(${scale})`;
      timeline.dataset.scale = String(scale);
    }

    function positionTimelineLine() {
      const line = document.getElementById("timeline-line");
      const timeline = document.querySelector(".timeline");
      const dateRanges = document.querySelectorAll(".date-range");
      if (!line || !timeline || dateRanges.length < 1) return;

      const scale = parseFloat(timeline.dataset.scale || "1");
      const tlRect = timeline.getBoundingClientRect();

      const firstRect = dateRanges[0].getBoundingClientRect();
      const lastRect = dateRanges[dateRanges.length - 1].getBoundingClientRect();

      const top = (firstRect.top - tlRect.top) / scale;
      const bottom = (lastRect.bottom - tlRect.top) / scale;
      const height = bottom - top;

      line.style.top = `${Math.max(0, top)}px`;
      line.style.left = "50%";
      line.style.height = `${Math.max(0, height)}px`;
    }

    function positionConnectors() {
      const rows = document.querySelectorAll(".timeline-row");
      rows.forEach(row => {
        const dateRange = row.querySelector(".date-range");
        const baseConnector = row.querySelector(".connector");
        if (!dateRange || !baseConnector) return;

        row.querySelectorAll(".connector.segment").forEach(seg => seg.remove());

        const rowRect = row.getBoundingClientRect();
        const dateRect = dateRange.getBoundingClientRect();
        const centerY = dateRect.top + dateRect.height / 2 - rowRect.top - 2;

        const leftEvents = row.querySelectorAll(".event-box-left");
        const rightEvents = row.querySelectorAll(".event-box-right");

        const leftTarget = leftEvents.length
          ? Array.from(leftEvents).reduce((closest, box) => {
              const rect = box.getBoundingClientRect();
              return !closest || rect.right > closest.getBoundingClientRect().right ? box : closest;
            }, null)
          : null;

        const rightTarget = rightEvents.length
          ? Array.from(rightEvents).reduce((closest, box) => {
              const rect = box.getBoundingClientRect();
              return !closest || rect.left < closest.getBoundingClientRect().left ? box : closest;
            }, null)
          : null;

        function drawSegment(startX, endX) {
          const seg = document.createElement("div");
          seg.className = "connector segment";
          seg.style.top = `${centerY}px`;
          seg.style.left = `${Math.min(startX, endX)}px`;
          seg.style.width = `${Math.abs(endX - startX)}px`;
          row.appendChild(seg);
        }

        const hasLeft = !!leftTarget;
        const hasRight = !!rightTarget;

        baseConnector.style.position = "absolute";
        baseConnector.style.height = "4px";
        baseConnector.style.top = `${centerY}px`;

        if (hasLeft && hasRight) {
          baseConnector.style.display = "none";
          const leftRect = leftTarget.getBoundingClientRect();
          const rightRect = rightTarget.getBoundingClientRect();
          drawSegment(leftRect.right - rowRect.left, dateRect.left - rowRect.left);
          drawSegment(dateRect.right - rowRect.left, rightRect.left - rowRect.left);
        } else if (hasLeft) {
          baseConnector.style.display = "block";
          const leftRect = leftTarget.getBoundingClientRect();
          const startX = Math.min(leftRect.right - rowRect.left, dateRect.left - rowRect.left);
          const endX = Math.max(leftRect.right - rowRect.left, dateRect.left - rowRect.left);
          baseConnector.style.left = `${startX}px`;
          baseConnector.style.width = `${endX - startX}px`;
        } else if (hasRight) {
          baseConnector.style.display = "block";
          const rightRect = rightTarget.getBoundingClientRect();
          const startX = Math.min(dateRect.right - rowRect.left, rightRect.left - rowRect.left);
          const endX = Math.max(dateRect.right - rowRect.left, rightRect.left - rowRect.left);
          baseConnector.style.left = `${startX}px`;
          baseConnector.style.width = `${endX - startX}px`;
        } else {
          baseConnector.style.display = "block";
          baseConnector.style.width = "0px";
          baseConnector.style.left = `${dateRect.left - rowRect.left}px`;
        }
      });
    }

    // =======================
    // Step 5: Bootstrapping
    // =======================
    function updateTimeline() {
      renderTimeline(events);
      scaleTimeline();
      requestAnimationFrame(() => {
        positionTimelineLine();
        positionConnectors();
      });
    }

    let resizeTimer = null;
    function onResize() {
      if (resizeTimer) clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => {
        scaleTimeline();
        requestAnimationFrame(() => {
          positionTimelineLine();
          positionConnectors();
        });
      }, 50);
    }

    function observeMutations() {
      const timeline = document.querySelector(".timeline");
      if (!timeline) return;
      const observer = new MutationObserver(() => {
        requestAnimationFrame(() => {
          positionTimelineLine();
          positionConnectors();
        });
      });
      observer.observe(timeline, { childList: true, subtree: true });
    }

    function setEvents(newEvents) {
      while (events.length) events.pop();
      newEvents.forEach(e => events.push(e));
      updateTimeline();
    }

    function addEvent(ev) {
      events.push(ev);
      updateTimeline();
    }

    window.addEventListener("load", () => {
      updateTimeline();
      observeMutations();
    });
    window.addEventListener("resize", onResize);

    // =======================
    // Step 6: Search
    // =======================
    function matchesQuery(ev, query) {
      const q = query.toLowerCase();
      return (
        (ev.title && ev.title.toLowerCase().includes(q)) ||
        (ev.description && ev.description.toLowerCase().includes(q)) ||
        (ev.range && ev.range.toLowerCase().includes(q))
      );
    }

    function highlightTextInElement(el, query) {
      if (!query) return;
      const regex = new RegExp(`(${query})`, "gi");
      el.innerHTML = el.textContent.replace(regex, `<span class="highlight">$1</span>`);
    }

    function searchTimeline(query) {
      if (!query) {
        updateTimeline();
        return;
      }

      const filtered = events.filter(ev => matchesQuery(ev, query));

      renderTimeline(filtered);
      scaleTimeline();
      requestAnimationFrame(() => {
        positionTimelineLine();
        positionConnectors();

        const titles = document.querySelectorAll(".event-title");
        const descs = document.querySelectorAll(".event-description");
        const ranges = document.querySelectorAll(".date-range");
        [...titles, ...descs, ...ranges].forEach(el => highlightTextInElement(el, query));
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      const searchInput = document.getElementById("timeline-search-input");
      if (searchInput) {
        searchInput.addEventListener("input", e => {
          searchTimeline(e.target.value);
        });
      }
    });

    // =======================
    // Back to top
    // =======================
    document.addEventListener("DOMContentLoaded", () => {
      const backToTop = document.getElementById("back-to-top");

      window.addEventListener("scroll", () => {
        if (window.scrollY > 200) {
          backToTop.classList.add("show");
        } else {
          backToTop.classList.remove("show");
        }
      });

      backToTop.addEventListener("click", () => {
        window.scrollTo({ top: 0, behavior: "smooth" });
      });
    });

    // =======================
    // Legend toggle + positioning
    // =======================
    const legendCard = document.getElementById("legend");
    const legendToggle = document.getElementById("legend-toggle");
    if (legendToggle && legendCard) {
      const headerIcon = legendToggle.querySelector(".header-icon");
      legendToggle.addEventListener("click", () => {
        legendCard.classList.toggle("collapsed");
        if (headerIcon) {
          headerIcon.textContent = legendCard.classList.contains("collapsed") ? "▶" : "▼";
        }
        requestAnimationFrame(placeLegendNoOverlap);
      });
    }

    const backToTopBtn = document.getElementById("back-to-top");
    if (backToTopBtn) {
      window.addEventListener("scroll", () => {
        backToTopBtn.classList.toggle("show", window.scrollY > 300);
      }, { passive: true });
      backToTopBtn.addEventListener("click", () => {
        window.scrollTo({ top: 0, behavior: "smooth" });
      });
    }

    function getAbsRect(el) {
      const r = el.getBoundingClientRect();
      return {
        top: r.top + window.scrollY,
        bottom: r.bottom + window.scrollY,
        height: r.height
      };
    }

    function placeLegendNoOverlap() {
      const legend = document.getElementById("legend");
      const ranges = document.querySelectorAll(".date-range");
      if (!legend || !ranges.length) return;

      legend.style.position = "fixed";
      legend.style.left = "50%";
      legend.style.transform = "translateX(-50%)";

      const legendHeight = legend.offsetHeight;
      const firstAbs = getAbsRect(ranges[0]);
      const minTopViewport = firstAbs.bottom - window.scrollY + 10;

      let desiredTopViewport = 10;

      for (const dr of ranges) {
        const abs = getAbsRect(dr);
        const desiredTopDoc = desiredTopViewport + window.scrollY;
        const desiredBottomDoc = desiredTopDoc + legendHeight;

        const overlaps = desiredTopDoc < abs.bottom && desiredBottomDoc > abs.top;
        if (overlaps) {
          desiredTopViewport = abs.bottom - window.scrollY + 10;
        }
      }

      if (desiredTopViewport < minTopViewport) {
        desiredTopViewport = minTopViewport;
      }

      legend.style.top = `${Math.round(desiredTopViewport)}px`;
    }

    window.addEventListener("load", () => {
      placeLegendNoOverlap();
      window.addEventListener("scroll", placeLegendNoOverlap, { passive: true });
      window.addEventListener("resize", placeLegendNoOverlap);
    });

    document.addEventListener("DOMContentLoaded", placeLegendNoOverlap);

    const searchInputLegend = document.getElementById("timeline-search-input");
    if (searchInputLegend) {
      searchInputLegend.addEventListener("input", () => {
        requestAnimationFrame(placeLegendNoOverlap);
      });
    }

    document.addEventListener("load", () => {
      requestAnimationFrame(placeLegendNoOverlap);
    }, true);
  </script>
</body>
</html>

